name: Get Old Tailscale

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      # 使用 Auth Key 认证安装旧版 Tailscale
      - name: Install Tailscale (Old Version)
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: "1.70.0"

      # 打包二进制文件
      - name: Package binaries
        run: |
          tar -czvf tailscale-binaries.tar.gz /usr/local/bin/tailscale* /usr/local/sbin/tailscale* 2>/dev/null || true
          if [ ! -s tailscale-binaries.tar.gz ]; then
            find / -name "tailscale" -o -name "tailscaled" 2>/dev/null | xargs tar -czvf tailscale-binaries.tar.gz 2>/dev/null || true
          fi

      # 上传工件 - 使用最新的 v4 版本
      - name: Upload binaries as artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-1.70.0-macos-binaries
          path: tailscale-binaries.tar.gz
          if-no-files-found: warn

      # 备用：将文件以 base64 形式输出到日志
      - name: Output binaries as base64 (backup download)
        if: always()
        run: |
          if [ -f tailscale-binaries.tar.gz ]; then
            echo "========================================="
            echo "BASE64 ENCODED FILE (COPY BELOW THIS LINE)"
            echo "========================================="
            base64 tailscale-binaries.tar.gz
            echo "========================================="
            echo "END OF BASE64 ENCODED FILE"
            echo "保存以上内容（包括 BEGIN/END 行）为 tailscale.txt，然后运行：base64 -d tailscale.txt > tailscale-binaries.tar.gz"
          else
            echo "未找到 tailscale-binaries.tar.gz 文件"
          fi
